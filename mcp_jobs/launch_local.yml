# Configuration de lancement local CHNeoWave
# Mode réparation - exécution contrôlée sans génération

mode: repair           # pas de génération, uniquement exécution contrôlée
ignore_paths:
  - "venv*/"
  - "__pycache__/"
  - "logs/**"
  - "exports/**"
  - "*.pyc"
  - "*.pyo"
  - ".git/"
  - "temp/"

# Configuration des tâches d'exécution
tasks:
  #–– 1/ Installation hors-ligne ––#
  - name: install_offline
    description: "Installation des optimisations CHNeoWave en mode hors-ligne"
    timeout: 300  # 5 minutes
    retry_count: 2
    run: >
      python -m __fixes__.install_optimizations
      --offline           # n'accède pas à Internet
      --wheelhouse local_packages/
      --force-reinstall
      --no-deps
    on_failure:
      - "echo 'Échec installation - vérifier local_packages/'"
      - "python -m __fixes__.install_optimizations --check-deps"

  #–– 2/ Validation matériel ––#
  - name: validate_hw
    description: "Validation des exigences matérielles du laboratoire"
    depends_on: ["install_offline"]
    timeout: 120  # 2 minutes
    run: >
      python -m __fixes__.hardware_requirements
      --validate
      --strict
      --report logs/hw_report.json
      --export-config config/hw_validated.json
    on_failure:
      - "echo 'Validation matérielle échouée - voir logs/hw_report.json'"
      - "python -m __fixes__.hardware_requirements --requirements-only"

  #–– 3/ Préparation configuration ––#
  - name: prepare_config
    description: "Préparation des fichiers de configuration"
    depends_on: ["validate_hw"]
    timeout: 60
    run: >
      mkdir -p config logs exports
      python -m __fixes__.optimization_config
      --generate-default config/chneowave_default.json
      --validate-geometry ${CHNW_GEOM:-config/probes_geom.json}
    on_failure:
      - "echo 'Échec préparation config - utilisation valeurs par défaut'"

  #–– 4/ Test de performance ––#
  - name: performance_check
    description: "Vérification des performances avant lancement"
    depends_on: ["prepare_config"]
    timeout: 180  # 3 minutes
    optional: true  # peut échouer sans arrêter le processus
    env:
      CHNW_BENCHMARK_MODE: "quick"
    run: >
      python -m __fixes__.benchmark_performance
      --quick-test
      --config __fixes__/bench_results_2025-07-15.json
      --output logs/perf_check.json
    on_failure:
      - "echo 'Tests de performance échoués - continuant avec configuration par défaut'"

  #–– 5/ Lancement logiciel principal ––#
  - name: launch_chneowave
    description: "Lancement du logiciel CHNeoWave en mode laboratoire"
    depends_on: ["prepare_config"]
    timeout: 0  # pas de timeout pour le processus principal
    env:
      CHNW_MODE: "offline"       # désactive toute télé-transmission
      CHNW_FS: "500"             # Hz (modifiable)
      CHNW_N_PROBES: "16"        # sondes (modifiable)
      CHNW_GEOM: "config/probes_geom.json"
      CHNW_LOG_LEVEL: "INFO"
      CHNW_BUFFER_SIZE: "8192"   # taille buffer circulaire
      CHNW_CACHE_SIZE: "256"     # MB pour cache FFT/Goda
      PYTHONPATH: "${PWD}:${PWD}/__fixes__"
    run: >
      python -m HRNeoWave.gui.main
      --config ${CHNW_GEOM}
      --offline
      --log-dir logs/
      --export-dir exports/
      --fs ${CHNW_FS}
      --probes ${CHNW_N_PROBES}
    on_failure:
      - "echo 'Échec lancement CHNeoWave - voir logs/'"
      - "python -m __fixes__.validate_optimizations --diagnose"

# Configuration globale
global_env:
  PYTHONUNBUFFERED: "1"        # sortie immédiate
  PYTHONDONTWRITEBYTECODE: "1" # pas de .pyc
  CHNW_WORKSPACE: "${PWD}"
  CHNW_CONFIG_DIR: "${PWD}/config"
  CHNW_LOG_DIR: "${PWD}/logs"
  CHNW_EXPORT_DIR: "${PWD}/exports"

# Gestion des erreurs
error_handling:
  stop_on_critical: true
  log_errors: true
  cleanup_on_exit: true
  backup_logs: true

# Nettoyage automatique
cleanup:
  - "echo 'Nettoyage des fichiers temporaires'"
  - "find . -name '*.pyc' -delete 2>/dev/null || true"
  - "find . -name '__pycache__' -type d -exec rm -rf {} + 2>/dev/null || true"
  - "echo 'Session CHNeoWave terminée - logs disponibles dans logs/'"

# Monitoring et surveillance
monitoring:
  cpu_threshold: 80     # % CPU max
  memory_threshold: 85  # % RAM max
  disk_threshold: 90    # % disque max
  check_interval: 30    # secondes

# Sécurité
security:
  disable_network: true     # mode offline strict
  restrict_file_access: true
  allowed_directories:
    - "${PWD}"
    - "${PWD}/config"
    - "${PWD}/logs"
    - "${PWD}/exports"
    - "${PWD}/__fixes__"
    - "${PWD}/HRNeoWave"

# Métadonnées
metadata:
  version: "1.0.0"
  created: "2025-01-15"
  description: "Configuration de lancement local pour CHNeoWave en mode laboratoire"
  author: "Équipe CHNeoWave"
  laboratory: "Laboratoire d'étude maritime - Méditerranée"
  notes:
    - "Mode offline strict - aucune connexion réseau"
    - "Validation matérielle obligatoire avant lancement"
    - "Configuration adaptée aux bassins et canaux méditerranéens"
    - "Support 3-16 sondes avec fréquences 100Hz-2kHz"