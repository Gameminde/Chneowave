#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script de test pour v√©rifier les corrections des probl√®mes d'affichage CHNeoWave
Teste chaque correction appliqu√©e et valide le fonctionnement

Auteur: Claude Sonnet 4 - Architecte Logiciel en Chef
Date: 28 Juillet 2025
Version: 1.0.0
"""

import sys
import logging
from pathlib import Path
from PySide6.QtWidgets import QApplication, QMainWindow, QLabel, QVBoxLayout, QWidget
from PySide6.QtCore import Qt, QTimer
from PySide6.QtGui import QFont

class CHNeoWaveFixTester:
    """Testeur des corrections CHNeoWave"""
    
    def __init__(self):
        self.tests_passed = 0
        self.tests_failed = 0
        self.errors = []
        
        # Configuration logging
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        self.logger = logging.getLogger('chneowave_tester')
    
    def test_qobject_import(self) -> bool:
        """Teste la correction de l'import QObject"""
        print("üß™ TEST 1: Import QObject")
        print("=" * 40)
        
        try:
            # Test d'import du contr√¥leur d'acquisition
            from hrneowave.gui.controllers.acquisition_controller import AcquisitionController
            print("‚úÖ Import AcquisitionController r√©ussi")
            
            # Test de cr√©ation d'une instance (sans lancer l'acquisition)
            config = type('Config', (), {
                'mode': type('Mode', (), {'SIMULATE': 'simulate'})(),
                'sample_rate': 32.0,
                'n_channels': 4,
                'buffer_size': 1000
            })()
            
            controller = AcquisitionController(config)
            print("‚úÖ Instance AcquisitionController cr√©√©e avec succ√®s")
            
            self.tests_passed += 1
            return True
            
        except Exception as e:
            error_msg = f"‚ùå Erreur import QObject: {e}"
            self.errors.append(error_msg)
            print(error_msg)
            self.tests_failed += 1
            return False
    
    def test_qapplication_management(self) -> bool:
        """Teste la gestion QApplication"""
        print("\nüß™ TEST 2: Gestion QApplication")
        print("=" * 40)
        
        try:
            app = QApplication(sys.argv)
            
            # Test cr√©ation MainWindow
            from hrneowave.gui.main_window import MainWindow
            window = MainWindow()
            
            # Test affichage
            window.show()
            window.raise_()
            window.activateWindow()
            
            # V√©rifications
            visible = window.isVisible()
            active = window.isActiveWindow()
            
            print(f"‚úÖ Fen√™tre cr√©√©e: Visible={visible}, Active={active}")
            
            # Fermer proprement
            window.close()
            app.quit()
            
            self.tests_passed += 1
            return True
            
        except Exception as e:
            error_msg = f"‚ùå Erreur gestion QApplication: {e}"
            self.errors.append(error_msg)
            print(error_msg)
            self.tests_failed += 1
            return False
    
    def test_css_properties(self) -> bool:
        """Teste les corrections CSS"""
        print("\nüß™ TEST 3: Propri√©t√©s CSS")
        print("=" * 40)
        
        try:
            # Test d'application du th√®me
            from hrneowave.gui.styles.theme_manager import ThemeManager
            
            app = QApplication(sys.argv)
            theme_manager = ThemeManager(app)
            theme_manager.apply_theme('maritime_modern')
            
            print("‚úÖ Th√®me maritime appliqu√© sans erreur")
            
            # Test cr√©ation widget avec style
            from hrneowave.gui.components.modern_card import ModernCard
            
            card = ModernCard("Test Card")
            card.show()
            
            print("‚úÖ ModernCard cr√©√© et affich√©")
            
            # Nettoyer
            card.close()
            app.quit()
            
            self.tests_passed += 1
            return True
            
        except Exception as e:
            error_msg = f"‚ùå Erreur propri√©t√©s CSS: {e}"
            self.errors.append(error_msg)
            print(error_msg)
            self.tests_failed += 1
            return False
    
    def test_qsizepolicy(self) -> bool:
        """Teste les corrections QSizePolicy"""
        print("\nüß™ TEST 4: QSizePolicy")
        print("=" * 40)
        
        try:
            from PySide6.QtWidgets import QSizePolicy
            
            # Test cr√©ation QSizePolicy avec valeurs enti√®res
            policy = QSizePolicy(7, 5)  # Expanding, Fixed
            print("‚úÖ QSizePolicy cr√©√© avec valeurs enti√®res")
            
            # Test application sur widget
            widget = QWidget()
            widget.setSizePolicy(policy)
            print("‚úÖ QSizePolicy appliqu√© sur widget")
            
            # Test avec valeurs .value
            policy2 = QSizePolicy()
            policy2.setHorizontalPolicy(QSizePolicy.Policy.Expanding)
            policy2.setVerticalPolicy(QSizePolicy.Policy.Fixed)
            print("‚úÖ QSizePolicy cr√©√© avec .value")
            
            self.tests_passed += 1
            return True
            
        except Exception as e:
            error_msg = f"‚ùå Erreur QSizePolicy: {e}"
            self.errors.append(error_msg)
            print(error_msg)
            self.tests_failed += 1
            return False
    
    def test_animations(self) -> bool:
        """Teste les corrections d'animations"""
        print("\nüß™ TEST 5: Animations Qt")
        print("=" * 40)
        
        try:
            from PySide6.QtCore import QPropertyAnimation, QEasingCurve
            from PySide6.QtWidgets import QPushButton
            
            app = QApplication(sys.argv)
            
            # Test cr√©ation animation
            button = QPushButton("Test Animation")
            animation = QPropertyAnimation(button, b"geometry")
            animation.setDuration(200)
            animation.setEasingCurve(QEasingCurve.OutCubic)
            
            print("‚úÖ Animation Qt cr√©√©e")
            
            # Test animation simple
            button.show()
            animation.setStartValue(button.geometry())
            animation.setEndValue(button.geometry().adjusted(10, 10, 10, 10))
            animation.start()
            
            print("‚úÖ Animation Qt lanc√©e")
            
            # Nettoyer
            button.close()
            app.quit()
            
            self.tests_passed += 1
            return True
            
        except Exception as e:
            error_msg = f"‚ùå Erreur animations: {e}"
            self.errors.append(error_msg)
            print(error_msg)
            self.tests_failed += 1
            return False
    
    def test_golden_ratio_layout(self) -> bool:
        """Teste les optimisations Golden Ratio"""
        print("\nüß™ TEST 6: Layout Golden Ratio")
        print("=" * 40)
        
        try:
            from hrneowave.gui.layouts.golden_ratio_layout import GoldenRatioLayout
            from PySide6.QtWidgets import QLabel
            
            app = QApplication(sys.argv)
            
            # Test cr√©ation layout
            layout = GoldenRatioLayout()
            print("‚úÖ GoldenRatioLayout cr√©√©")
            
            # Test ajout widgets
            label1 = QLabel("Widget 1")
            label2 = QLabel("Widget 2")
            
            layout.addWidget(label1)
            layout.addWidget(label2)
            
            print("‚úÖ Widgets ajout√©s au layout")
            
            # Test calcul sections
            if hasattr(layout, '_calculate_golden_sections'):
                print("‚úÖ M√©thode _calculate_golden_sections pr√©sente")
            
            app.quit()
            
            self.tests_passed += 1
            return True
            
        except Exception as e:
            error_msg = f"‚ùå Erreur layout Golden Ratio: {e}"
            self.errors.append(error_msg)
            print(error_msg)
            self.tests_failed += 1
            return False
    
    def test_complete_interface(self) -> bool:
        """Teste l'interface compl√®te"""
        print("\nüß™ TEST 7: Interface Compl√®te")
        print("=" * 40)
        
        try:
            app = QApplication(sys.argv)
            
            # Test cr√©ation interface compl√®te
            from hrneowave.gui.main_window import MainWindow
            
            window = MainWindow()
            window.show()
            window.raise_()
            window.activateWindow()
            
            # V√©rifications critiques
            visible = window.isVisible()
            active = window.isActiveWindow()
            minimized = window.isMinimized()
            
            print(f"‚úÖ Interface cr√©√©e: Visible={visible}, Active={active}, Minimized={minimized}")
            
            if visible and not minimized:
                print("üéâ SUCC√àS: Interface CHNeoWave fonctionnelle!")
                self.tests_passed += 1
                
                # Fermer apr√®s 2 secondes
                timer = QTimer()
                timer.timeout.connect(app.quit)
                timer.start(2000)
                
                app.exec()
                return True
            else:
                print("‚ö†Ô∏è Interface cr√©√©e mais probl√®mes d'affichage")
                self.tests_failed += 1
                return False
                
        except Exception as e:
            error_msg = f"‚ùå Erreur interface compl√®te: {e}"
            self.errors.append(error_msg)
            print(error_msg)
            self.tests_failed += 1
            return False
    
    def run_all_tests(self) -> bool:
        """Lance tous les tests"""
        print("üöÄ LANCEMENT DES TESTS DE VALIDATION CHNEOWAVE")
        print("=" * 60)
        
        tests = [
            self.test_qobject_import,
            self.test_qapplication_management,
            self.test_css_properties,
            self.test_qsizepolicy,
            self.test_animations,
            self.test_golden_ratio_layout,
            self.test_complete_interface
        ]
        
        for test in tests:
            try:
                test()
            except Exception as e:
                print(f"‚ùå Erreur lors du test: {e}")
                self.tests_failed += 1
        
        return self.generate_test_report()
    
    def generate_test_report(self) -> bool:
        """G√©n√®re le rapport de test"""
        print("\nüìä RAPPORT DE TESTS")
        print("=" * 50)
        
        total_tests = self.tests_passed + self.tests_failed
        
        print(f"Tests r√©ussis: {self.tests_passed}/{total_tests}")
        print(f"Tests √©chou√©s: {self.tests_failed}/{total_tests}")
        print(f"Taux de succ√®s: {(self.tests_passed/total_tests)*100:.1f}%")
        
        if self.errors:
            print("\n‚ùå Erreurs rencontr√©es:")
            for error in self.errors:
                print(f"  ‚Ä¢ {error}")
        
        success = self.tests_failed == 0
        
        if success:
            print("\nüéâ TOUS LES TESTS R√âUSSIS!")
            print("‚úÖ CHNeoWave est pr√™t √† √™tre utilis√©")
        else:
            print("\n‚ö†Ô∏è CERTAINS TESTS ONT √âCHOU√â")
            print("‚ùå Des probl√®mes persistent")
        
        # Sauvegarder le rapport
        report_file = Path("test_report.txt")
        with open(report_file, 'w', encoding='utf-8') as f:
            f.write("RAPPORT DE TESTS CHNEOWAVE\n")
            f.write("=" * 50 + "\n\n")
            f.write(f"Tests r√©ussis: {self.tests_passed}/{total_tests}\n")
            f.write(f"Tests √©chou√©s: {self.tests_failed}/{total_tests}\n")
            f.write(f"Taux de succ√®s: {(self.tests_passed/total_tests)*100:.1f}%\n\n")
            
            if self.errors:
                f.write("ERREURS:\n")
                for error in self.errors:
                    f.write(f"  ‚Ä¢ {error}\n")
        
        print(f"üìÑ Rapport sauvegard√©: {report_file}")
        
        return success

def main():
    """Point d'entr√©e principal"""
    print("üß™ TESTEUR DE CORRECTIONS CHNEOWAVE")
    print("=" * 50)
    
    # Ajouter le chemin du projet
    sys.path.insert(0, str(Path(__file__).parent / "src"))
    
    # Cr√©er le testeur
    tester = CHNeoWaveFixTester()
    
    # Lancer tous les tests
    success = tester.run_all_tests()
    
    return 0 if success else 1

if __name__ == "__main__":
    exit(main()) 