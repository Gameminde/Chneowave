#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Fenêtre principale pour CHNeoWave
Gestion des signaux de projet et coordination des vues
"""

from PyQt5.QtWidgets import QMainWindow, QMessageBox
from PyQt5.QtCore import pyqtSignal, pyqtSlot
from hrneowave.core.signal_bus import get_error_bus, ErrorLevel
from .view_manager import ViewManager

# Import des vues
from .views.welcome_view import WelcomeView
from .views.acquisition_view import AcquisitionView
from .views.analysis_view import AnalysisView
from hrneowave.gui.controllers.acquisition_controller import AcquisitionController


# Import des widgets
try:
    from .widgets.infos_essai_dock import InfosEssaiDock
except ImportError:
    InfosEssaiDock = None

try:
    from .widgets.etat_capteurs_dock import EtatCapteursDock
except ImportError:
    EtatCapteursDock = None


class MainWindow(QMainWindow):
    """Fenêtre principale de l'application CHNeoWave"""
    
    projectCreated = pyqtSignal()          # nouveau signal
    
    def __init__(self, config=None, parent=None):
        # Import des classes Qt seulement quand nécessaire
        from PyQt5.QtWidgets import QStackedWidget, QVBoxLayout, QWidget
        from PyQt5.QtCore import Qt
        
        super().__init__(parent)
        self.setWindowTitle("CHNeoWave")
        self.setMinimumSize(1024, 768)
        
        # Configuration
        self.config = config or {}
        
        # Métadonnées du projet
        self.project_meta = {}             # renseigné par WelcomeView
        
        # État de l'application
        self.is_acquiring = False
        self.acquisition_controller = None
        self.analysis_controller = None
        self.project_controller = None
        
        # Construction de l'interface
        self._build_ui()
        self._setup_docks()
        self._setup_menu()
        self._setup_status_bar()
        self._setup_connections()
    
    def _build_ui(self):
        """Construit l'interface utilisateur principale"""
        from PyQt5.QtWidgets import QStackedWidget, QVBoxLayout, QWidget
        
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        layout = QVBoxLayout(central_widget)
        layout.setContentsMargins(0, 0, 0, 0)

        self.stack_widget = QStackedWidget()
        layout.addWidget(self.stack_widget)

        # Initialiser le gestionnaire de vues
        from hrneowave.gui.view_manager import get_view_manager
        self.view_manager = get_view_manager(self.stack_widget)

        self._create_and_register_views()
    
    def _create_and_register_views(self):
        """Crée et enregistre les vues auprès du ViewManager"""
        self.welcome_view = WelcomeView()
        self.view_manager.register_view('welcome', self.welcome_view)

        self.acquisition_view = AcquisitionView()
        self.view_manager.register_view('acquisition', self.acquisition_view)

        self.analysis_view = AnalysisView()
        self.view_manager.register_view('analysis', self.analysis_view)

        # Initialiser les contrôleurs
        self._create_project_controller()
        self._create_analysis_controller()
        self._create_acquisition_controller()

        # Démarrer sur la vue d'accueil
        self.view_manager.switch_to_view('welcome')
    
    def _setup_docks(self):
        """Configure les docks widgets"""
        from PyQt5.QtCore import Qt
        
        # Dock Infos Essai
        if InfosEssaiDock:
            self.infos_essai_dock = InfosEssaiDock(self)
            self.addDockWidget(Qt.RightDockWidgetArea, self.infos_essai_dock)
            
            # Connecter les signaux du dock
            self.infos_essai_dock.essai_updated.connect(self._on_essai_updated)
        else:
            self.infos_essai_dock = None
        
        # Dock État Capteurs
        if EtatCapteursDock:
            self.etat_capteurs_dock = EtatCapteursDock(self)
            self.addDockWidget(Qt.LeftDockWidgetArea, self.etat_capteurs_dock)
            
            # Connecter les signaux du dock
            self.etat_capteurs_dock.capteur_selected.connect(self._on_capteur_selected)
            self.etat_capteurs_dock.capteurs_updated.connect(self._on_capteurs_updated)
        else:
            self.etat_capteurs_dock = None
    
    def _setup_menu(self):
        """Configure la barre de menu"""
        from PyQt5.QtWidgets import QAction
        
        menubar = self.menuBar()
        
        # Menu Fichier
        file_menu = menubar.addMenu('Fichier')
        
        new_action = QAction('Nouveau projet', self)
        new_action.setShortcut('Ctrl+N')
        new_action.triggered.connect(self._new_project)
        file_menu.addAction(new_action)
        
        file_menu.addSeparator()
        
        quit_action = QAction('Quitter', self)
        quit_action.setShortcut('Ctrl+Q')
        quit_action.triggered.connect(self.close)
        file_menu.addAction(quit_action)
        
        # Menu Vues
        view_menu = menubar.addMenu('Vues')

        welcome_action = QAction('Accueil', self)
        welcome_action.triggered.connect(lambda: self.view_manager.switch_to_view('welcome'))
        view_menu.addAction(welcome_action)

        acquisition_action = QAction('Acquisition', self)
        acquisition_action.triggered.connect(lambda: self.view_manager.switch_to_view('acquisition'))
        view_menu.addAction(acquisition_action)

        analysis_action = QAction('Analyse', self)
        analysis_action.triggered.connect(lambda: self.view_manager.switch_to_view('analysis'))
        view_menu.addAction(analysis_action)
    
    def _create_project_controller(self):
        """Crée et configure le gestionnaire de projet."""
        from ..core.project_manager import ProjectManager
        self.project_controller = ProjectManager()

    def _setup_status_bar(self):
        """Configure la barre de statut"""
        from PyQt5.QtWidgets import QStatusBar
        
        self.status_bar = QStatusBar()
        self.setStatusBar(self.status_bar)
        self.status_bar.showMessage("Prêt")
    
    def _create_acquisition_controller(self):
        """Crée et configure le contrôleur d'acquisition."""
        from hrneowave.gui.controllers.acquisition_controller import AcquisitionConfig, AcquisitionMode
        
        # Créer une configuration d'acquisition par défaut
        acquisition_config = AcquisitionConfig(
            mode=AcquisitionMode.SIMULATE,
            sample_rate=1000,
            n_channels=4,
            buffer_size=10000
        )
        
        # Créer le contrôleur d'acquisition
        self.acquisition_controller = AcquisitionController(config=acquisition_config)
        self.acquisition_view.set_controller(self.acquisition_controller)

        # Connecter les signaux du contrôleur à l'interface
        if hasattr(self.acquisition_controller, 'acquisition_started'):
            self.acquisition_controller.acquisition_started.connect(self._on_acquisition_started)
        if hasattr(self.acquisition_controller, 'acquisition_stopped'):
            self.acquisition_controller.acquisition_stopped.connect(self._on_acquisition_stopped)
        if hasattr(self.acquisition_controller, 'acquisition_progress'):
            self.acquisition_controller.acquisition_progress.connect(self.update_acquisition_progress)

    def _create_analysis_controller(self):
        """Configure la vue d'analyse (pas de contrôleur séparé)."""
        # AnalysisView fonctionne de manière autonome
        # Connecter directement les signaux de la vue
        if hasattr(self.analysis_view, 'analysisFinished'):
            self.analysis_view.analysisFinished.connect(self._on_analysis_finished)

    def _setup_connections(self):
        """Configure les connexions de signaux"""
        # Connexions liées au projet
        if self.project_controller:
            self.project_controller.project_created.connect(self._on_project_created)
            self.project_controller.project_creation_failed.connect(self._on_project_creation_failed)

        if self.welcome_view:
            self.welcome_view.projectCreated.connect(self.project_controller.create_project)

        # Connexions liées à l'état de l'application
        self.projectCreated.connect(self._unlock_acquisition)
        
        # État initial des boutons
        if self.acquisition_view:
            if hasattr(self.acquisition_view, 'btn_start'):
                self.acquisition_view.btn_start.setEnabled(False)
            if hasattr(self.acquisition_view, 'btn_export'):
                self.acquisition_view.btn_export.setEnabled(False)
    
    @pyqtSlot()
    def _unlock_acquisition(self):
        """Déverrouille les fonctionnalités d'acquisition après création du projet"""
        if self.acquisition_view:
            # Activer les boutons d'acquisition
            if hasattr(self.acquisition_view, 'btn_start'):
                self.acquisition_view.btn_start.setEnabled(True)
            if hasattr(self.acquisition_view, 'btn_export'):
                self.acquisition_view.btn_export.setEnabled(True)
        
        # Mettre à jour la barre de titre avec les métadonnées du projet
        meta = self.project_meta
        if meta:
            title = f"CHNeoWave – {meta.get('name', 'Projet')} ({meta.get('owner', 'Inconnu')}, {meta.get('date', 'Date inconnue')})"
            self.setWindowTitle(title)
        
        # Mettre à jour la barre de statut
        self.status_bar.showMessage(f"Projet '{meta.get('name', 'Inconnu')}' créé - Acquisition disponible")
    
    @pyqtSlot(dict)
    def _on_project_created(self, project_meta):
        """Gère la création réussie d'un projet par le contrôleur."""
        self.project_meta = project_meta
        
        # Mettre à jour le dock infos essai avec les données du projet
        if self.infos_essai_dock:
            self.infos_essai_dock.set_essai_info(
                nom=project_meta.get('name', 'Nouveau projet'),
                operateur=project_meta.get('owner', 'Utilisateur'),
                configuration=project_meta.get('type', 'Standard')
            )
        
        self.projectCreated.emit()
        self.view_manager.switch_to_view('acquisition')

    @pyqtSlot(str, str)
    def _on_project_creation_failed(self, error_title, error_message):
        """Affiche une erreur si la création du projet échoue."""
        QMessageBox.critical(self, error_title, error_message)
        self.status_bar.showMessage("Échec de la création du projet")
    
    @pyqtSlot(dict)
    def _on_essai_updated(self, essai_data):
        """Gère les mises à jour des informations d'essai"""
        # Mettre à jour la barre de statut avec les infos essai
        statut = essai_data.get('statut', 'Inconnu')
        nom = essai_data.get('nom', 'Essai')
        
        if statut == 'En cours':
            duree = essai_data.get('duree', '00:00:00')
            nb_echantillons = essai_data.get('nb_echantillons', 0)
            self.status_bar.showMessage(f"Acquisition en cours - {nom} - Durée: {duree} - Échantillons: {nb_echantillons:,}")
        elif statut == 'Pause':
            self.status_bar.showMessage(f"Acquisition en pause - {nom}")
        elif statut == 'Arrêté':
            self.status_bar.showMessage(f"Acquisition arrêtée - {nom}")
        else:
            self.status_bar.showMessage(f"Statut: {statut} - {nom}")
    
    def start_acquisition(self):
        """Démarre une acquisition via le contrôleur."""
        if self.acquisition_controller and self.project_meta:
            self.acquisition_controller.start()

    def _on_acquisition_started(self):
        """Gère le démarrage effectif de l'acquisition."""
        self.is_acquiring = True
        if self.infos_essai_dock:
            self.infos_essai_dock.start_essai(
                nom=self.project_meta.get('name', 'Acquisition'),
                operateur=self.project_meta.get('owner', 'Utilisateur'),
                configuration=self.project_meta.get('type', 'Standard')
            )
    
    def stop_acquisition(self):
        """Arrête l'acquisition en cours via le contrôleur."""
        if self.acquisition_controller:
            self.acquisition_controller.stop()

    def _on_acquisition_stopped(self):
        """Gère l'arrêt effectif de l'acquisition."""
        self.is_acquiring = False
        if self.infos_essai_dock:
            self.infos_essai_dock.stop_essai()

    def _on_analysis_finished(self, results):
        """Gère la fin de l'analyse."""
        self.status_bar.showMessage("Analyse terminée.")
        # AnalysisView gère ses propres résultats
        self.is_acquiring = False
        if self.infos_essai_dock:
            self.infos_essai_dock.stop_essai()
    
    def pause_acquisition(self):
        """Met en pause l'acquisition via le contrôleur."""
        if self.acquisition_controller:
            self.acquisition_controller.pause()
        if self.infos_essai_dock:
            self.infos_essai_dock.pause_essai()
    
    def resume_acquisition(self):
        """Reprend l'acquisition via le contrôleur."""
        if self.acquisition_controller:
            self.acquisition_controller.resume()
        if self.infos_essai_dock:
            self.infos_essai_dock.resume_essai()
    
    def update_acquisition_progress(self, nb_echantillons):
        """Met à jour le progrès de l'acquisition"""
        if self.infos_essai_dock:
            self.infos_essai_dock.update_echantillons(nb_echantillons)
    
    @pyqtSlot(int)
    def _on_capteur_selected(self, capteur_id):
        """Gère la sélection d'un capteur"""
        # Mettre à jour la barre de statut
        self.status_bar.showMessage(f"Capteur {capteur_id} sélectionné")
        
        # Émettre un signal pour les autres composants
        # TODO: Connecter aux vues qui ont besoin de cette information
        print(f"Capteur {capteur_id} sélectionné")
    
    @pyqtSlot(dict)
    def _on_capteurs_updated(self, capteurs_data):
        """Gère les mises à jour des capteurs"""
        # Calculer des statistiques pour la barre de statut
        capteurs = capteurs_data.get('capteurs', {})
        nb_connectes = sum(1 for c in capteurs.values() if c['etat'] in ['Connecté', 'Acquisition'])
        nb_acquisition = sum(1 for c in capteurs.values() if c['etat'] == 'Acquisition')
        nb_erreurs = sum(1 for c in capteurs.values() if c['etat'] == 'Erreur')
        
        # Mettre à jour la barre de statut si pas d'acquisition en cours
        if not self.is_acquiring:
            status_msg = f"Capteurs: {nb_connectes}/{len(capteurs)} connectés"
            if nb_acquisition > 0:
                status_msg += f" | {nb_acquisition} en acquisition"
            if nb_erreurs > 0:
                status_msg += f" | {nb_erreurs} erreurs"
            
            self.status_bar.showMessage(status_msg)
    
    def set_capteurs_config(self, nb_capteurs: int):
        """Configure le nombre de capteurs"""
        if self.etat_capteurs_dock:
            self.etat_capteurs_dock.spin_nb_capteurs.setValue(nb_capteurs)
    
    def start_capteurs_simulation(self):
        """Démarre la simulation des capteurs"""
        if self.etat_capteurs_dock:
            self.etat_capteurs_dock.start_simulation()
    
    def stop_capteurs_simulation(self):
        """Arrête la simulation des capteurs"""
        if self.etat_capteurs_dock:
            self.etat_capteurs_dock.stop_simulation()
    
    def update_capteur_data(self, capteur_id: int, **kwargs):
        """Met à jour les données d'un capteur spécifique"""
        if self.etat_capteurs_dock:
            self.etat_capteurs_dock.set_capteur_data(capteur_id, **kwargs)
    
    def _new_project(self):
        """Crée un nouveau projet via le contrôleur."""
        if self.is_acquiring:
            get_error_bus().emit_error(
                ErrorLevel.WARNING,
                "Impossible de créer un nouveau projet pendant l'acquisition.",
                source='MainWindow'
            )
            return

        # Réinitialisation via le contrôleur de projet si nécessaire
        # Pour l'instant, on se contente de revenir à l'écran d'accueil

        # Réinitialiser l'état de l'interface
        self.project_meta = {}
        if self.acquisition_view:
            if hasattr(self.acquisition_view, 'btn_start'):
                self.acquisition_view.btn_start.setEnabled(False)
            if hasattr(self.acquisition_view, 'btn_export'):
                self.acquisition_view.btn_export.setEnabled(False)

        if self.welcome_view and hasattr(self.welcome_view, 'reset_form'):
            self.welcome_view.reset_form()

        self.view_manager.switch_to_view('welcome')
        self.setWindowTitle("CHNeoWave")
        self.status_bar.showMessage("Nouveau projet - Veuillez renseigner les informations")
    
    def get_current_view(self):
        """Retourne la vue actuellement active"""
        return self.view_manager.current_view
    
    def closeEvent(self, event):
        """Gère la fermeture de l'application"""
        if self.is_acquiring:
            reply = QMessageBox.question(
                self,
                'Fermeture',
                'Une acquisition est en cours. Voulez-vous vraiment quitter ?',
                QMessageBox.Yes | QMessageBox.No,
                QMessageBox.No
            )

            if reply == QMessageBox.Yes:
                event.accept()
            else:
                event.ignore()
        else:
            event.accept()